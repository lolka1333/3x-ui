# Исправление проблемы генерации ключей Shadowsocks 2022

## Описание проблемы

Были обнаружены следующие проблемы с генерацией ключей для Shadowsocks 2022:

1. **Пустые поля пароля**: При создании новых inbound'ов для Shadowsocks 2022 поля пароля оставались пустыми, что приводило к ошибке "bad key" на клиенте.

2. **Некорректная генерация ключей в Go**: В функции `randomShadowSocksPassword()` в случае ошибки генерации криптостойких случайных байтов возвращалась обычная строка вместо base64-кодированного ключа.

3. **Отсутствие автоматической генерации**: При создании новых конфигураций Shadowsocks ключи не генерировались автоматически.

## Исправления

### 1. JavaScript (web/assets/js/model/inbound.js)

#### Исправлен конструктор `Inbound.ShadowsocksSettings`:
- Добавлена автоматическая генерация пароля для Shadowsocks 2022 методов
- Добавлен метод `isSS2022()` для проверки методов шифрования 2022

#### Исправлен конструктор `Inbound.ShadowsocksSettings.Shadowsocks`:
- Добавлена автоматическая генерация паролей для клиентов Shadowsocks 2022
- Добавлен аналогичный метод проверки `isSS2022()`

### 2. Go (web/service/tgbot.go)

#### Исправлена функция `randomShadowSocksPassword()`:
- Улучшена обработка ошибок при генерации криптостойких случайных байтов
- Добавлен механизм повторных попыток (до 10 раз)
- В качестве fallback используется time-based seed с `math/rand` вместо обычной строки
- Всегда возвращается корректный base64-кодированный ключ

#### Добавлены импорты:
- Добавлен импорт `mathRand "math/rand"` для fallback генератора

## Методы Shadowsocks 2022

Исправления применяются для следующих методов шифрования:
- `2022-blake3-aes-128-gcm` (ключ 16 байт)
- `2022-blake3-aes-256-gcm` (ключ 32 байта)
- `2022-blake3-chacha20-poly1305` (ключ 32 байта)

## Результат

После исправлений:

1. ✅ При создании новых inbound'ов Shadowsocks 2022 автоматически генерируются корректные base64 ключи
2. ✅ Кнопка генерации ключей в веб-интерфейсе работает корректно
3. ✅ Telegram бот генерирует только корректные base64 ключи
4. ✅ Исчезают ошибки "bad key" на клиентах
5. ✅ Поддерживается правильная длина ключей для разных методов шифрования

## Автоматическая генерация

Теперь ключи генерируются автоматически в следующих случаях:
- При создании нового inbound'а с протоколом Shadowsocks и методом 2022
- При добавлении нового клиента через веб-интерфейс
- При генерации через Telegram бот
- При нажатии кнопки обновления ключа в интерфейсе

## Совместимость

Исправления полностью совместимы с существующими конфигурациями и не влияют на работу обычных методов Shadowsocks (не 2022).